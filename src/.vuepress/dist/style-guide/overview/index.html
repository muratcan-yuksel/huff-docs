<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Style Guide | Huff Language</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Documentation for the Huff Language">
    <meta name="theme-color" content="#c70202">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.b0a66cc0.css" as="style"><link rel="preload" href="/assets/js/app.f80e70d4.js" as="script"><link rel="preload" href="/assets/js/2.fbc25f86.js" as="script"><link rel="preload" href="/assets/js/19.1dae433e.js" as="script"><link rel="prefetch" href="/assets/js/10.10b20d65.js"><link rel="prefetch" href="/assets/js/11.0a86e14c.js"><link rel="prefetch" href="/assets/js/12.ff418896.js"><link rel="prefetch" href="/assets/js/13.dbd310d9.js"><link rel="prefetch" href="/assets/js/14.f739287c.js"><link rel="prefetch" href="/assets/js/15.1d27754b.js"><link rel="prefetch" href="/assets/js/16.b8ce2f87.js"><link rel="prefetch" href="/assets/js/17.de757f34.js"><link rel="prefetch" href="/assets/js/18.15596483.js"><link rel="prefetch" href="/assets/js/20.76bad82f.js"><link rel="prefetch" href="/assets/js/21.21c7a29d.js"><link rel="prefetch" href="/assets/js/22.5f47afa2.js"><link rel="prefetch" href="/assets/js/23.4b38c2c8.js"><link rel="prefetch" href="/assets/js/24.da206082.js"><link rel="prefetch" href="/assets/js/25.4709b487.js"><link rel="prefetch" href="/assets/js/3.ccc119cc.js"><link rel="prefetch" href="/assets/js/4.0afa7f3a.js"><link rel="prefetch" href="/assets/js/5.75baa7dd.js"><link rel="prefetch" href="/assets/js/6.61d95085.js"><link rel="prefetch" href="/assets/js/7.bffed0f4.js"><link rel="prefetch" href="/assets/js/8.3e96e297.js"><link rel="prefetch" href="/assets/js/9.a12888d8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0a66cc0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Huff Language</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/get-started/overview/" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/tutorial/overview/" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><a href="/style-guide/overview/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Style Guide
</a></div><div class="nav-item"><a href="/resources/overview/" class="nav-link">
  Resources
</a></div><div class="nav-item"><a href="/contribute/overview/" class="nav-link">
  Contribute
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/get-started/overview/" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/tutorial/overview/" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><a href="/style-guide/overview/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Style Guide
</a></div><div class="nav-item"><a href="/resources/overview/" class="nav-link">
  Resources
</a></div><div class="nav-item"><a href="/contribute/overview/" class="nav-link">
  Contribute
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Style Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/style-guide/overview/" aria-current="page" class="active sidebar-link">Style Guide</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/style-guide/overview/#formatting" class="sidebar-link">Formatting</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#file-structure" class="sidebar-link">File Structure</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#natspec-comments" class="sidebar-link">Natspec Comments</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#code-comments" class="sidebar-link">Code Comments</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#macro-definition" class="sidebar-link">Macro Definition</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#function-abi-definition" class="sidebar-link">Function ABI Definition</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#event-abi-definition" class="sidebar-link">Event ABI Definition</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#jump-labels" class="sidebar-link">Jump Labels</a></li><li class="sidebar-sub-header"><a href="/style-guide/overview/#contract-call-return" class="sidebar-link">Contract Call Return</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="style-guide"><a href="#style-guide" class="header-anchor">#</a> Style Guide</h1> <p>The following is a style-guide for the Huff-Std library. <a href="https://discord.gg/xabvMWDpEf" target="_blank" rel="noopener noreferrer">Feedback and discussion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is welcome.</p> <h2 id="formatting"><a href="#formatting" class="header-anchor">#</a> Formatting</h2> <p>Lines should be no greater than 100 characters (disregarding long constant names/values).</p> <p>Files should use 4 spaces for indentions.</p> <h2 id="file-structure"><a href="#file-structure" class="header-anchor">#</a> File Structure</h2> <p>The file structure of a Huff contract so follow this:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">/* Imports */</span>
#include <span class="token string">&quot;./contracts/utils/ExampleImport1.huff&quot;</span>
#include <span class="token string">&quot;./contracts/utils/ExampleImport2.huff&quot;</span>

<span class="token comment">/* Function Interfaces */</span>
#define <span class="token keyword">function</span> <span class="token function">exampleFunction1</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> nonpayable <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
#define <span class="token keyword">function</span> <span class="token function">exampleFunction2</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> nonpayable <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

#define <span class="token keyword">function</span> <span class="token function">exampleFunction3</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> nonpayable <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
#define <span class="token keyword">function</span> <span class="token function">exampleFunction4</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> nonpayable <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

#define <span class="token keyword">event</span> <span class="token function">ExampleEvent1</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> example<span class="token punctuation">)</span>
#define <span class="token keyword">event</span> <span class="token function">ExampleEvent2</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> example<span class="token punctuation">)</span>

<span class="token comment">/* Events Signatures */</span>
#define <span class="token keyword">constant</span> EXAMPLE_EVENT_SIGNATURE1 <span class="token operator">=</span> <span class="token number">0xDDF252AD1BE2C89B69C2B068FC378DAA952BA7F163C4A11628F55A4DF523B3EF</span>
#define <span class="token keyword">constant</span> EXAMPLE_EVENT_SIGNATURE2 <span class="token operator">=</span> <span class="token number">0x8C5BE1E5EBEC7D5BD14F71427D1E84F3DD0314C0F7B2291E5B200AC8C7C3B925</span>

<span class="token comment">/* Storage Slots */</span>
#define <span class="token keyword">constant</span> EXAMPLE_SLOT1 <span class="token operator">=</span> <span class="token function">FREE_STORAGE_POINTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
#define <span class="token keyword">constant</span> EXAMPLE_SLOT2 <span class="token operator">=</span> <span class="token function">FREE_STORAGE_POINTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
#define <span class="token keyword">constant</span> EXAMPLE_SLOT3 <span class="token operator">=</span> <span class="token function">FREE_STORAGE_POINTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/* Constructor */</span>
#define macro <span class="token function">CONSTRUCTOR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">takes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* Macros */</span>
#define macro <span class="token function">MYMAC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* Entry Point */</span>
#define macro <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>The next aspect of this is more complicated, because it depends on the context and functionality of the contract. Essentially, we want to categorize macros into sections based on their functionality. Here is an example from an existing ERC20 contract:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">/* Accounting Macros */</span>
#define macro <span class="token function">BALANCE_OF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
#define macro <span class="token function">TOTAL_SUPPLY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
#define macro <span class="token function">ALLOWANCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* Transfer Macros */</span>
#define macro <span class="token function">TRANSFER_TAKE_FROM</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">takes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
#define macro <span class="token function">TRANSFER_GIVE_TO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">takes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
#define macro <span class="token function">TRANSFER</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">takes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* Approval Macros */</span>
#define macro <span class="token function">APPROVE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">/* Mint Macros */</span>
#define macro <span class="token function">MINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">takes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="natspec-comments"><a href="#natspec-comments" class="header-anchor">#</a> Natspec Comments</h2> <p>To make Huff as easy as possible to transition to from Solidity, Natspec comments are encouraged for use in the contract.</p> <p>At the top of a Huff file, it is recommended to include the following natspec comments:</p> <div class="language-md extra-class"><pre class="language-md"><code>/// @title The title of the contract
/// @author The contract author
/// @notice A short description of the contract
</code></pre></div><p>Macros are also encouraged to include natspec comments where useful. For example, huffmate's <a href="https://github.com/pentagonxyz/huffmate/blob/main/src/utils/Multicallable.huff#L14-L21" target="_blank" rel="noopener noreferrer">Multicallable Huff Contract<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> contains the following macro natspec above the <code>MULTICALL()</code> macro.</p> <div class="language-md extra-class"><pre class="language-md"><code>/// @notice Multicall function entry point.
/// @dev This macro should be placed alone under a function selector's jump label.
///
/// Expected calldata: <span class="token code-snippet code keyword">`bytes[]`</span> containing valid ABI-encoded function calls
/// as elements.
///
/// Note: this macro only allows for multicalling functions that are within
/// the contract it is invoked in.
</code></pre></div><h2 id="code-comments"><a href="#code-comments" class="header-anchor">#</a> Code Comments</h2> <p>Comments should use the double slash (<code>//</code>) syntax, unless they are used to mark a new section of the codebase (see above).</p> <p>Comments describing the functionality of a statement, macro, etc should be on the line(s) prior.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// owner slot</span>
#define <span class="token keyword">constant</span> OWNER_SLOT <span class="token operator">=</span> <span class="token function">FREE_STORAGE_POINTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Comments indicating the stack <em>after</em> an instruction should be on the right of the instruction. Instruction comments within the same code block should be aligned vertically with the right-most instruction comment. The right-most instruction comment should be one “tab” from the right of the instruction.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token number">0x20</span>    <span class="token comment">// [value]</span>
<span class="token number">0x00</span>    <span class="token comment">// [offset, value]</span>
mstore  <span class="token comment">// []</span>
</code></pre></div><h2 id="macro-definition"><a href="#macro-definition" class="header-anchor">#</a> Macro Definition</h2> <p>Macros with a non-zero <code>takes</code> expectation should include a single comment at the start of the code block indicating the expected stack in the following format.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// Reverts if caller is not the owner.</span>
#define macro <span class="token function">ONLY_OWNER</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// takes: [calling_address]</span>
    <span class="token punctuation">[</span>OWNER_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [owner_slot, calling_address]</span>
    sload         <span class="token comment">// [owner_address, calling_address]</span>
    eq            <span class="token comment">// [is_owner]</span>
    is_owner      <span class="token comment">// [is_owner_jumpdest, is_owner]</span>
    jumpi         <span class="token comment">// []</span>
    <span class="token number">0x00</span>          <span class="token comment">// [revert_size]</span>
    <span class="token number">0x00</span>          <span class="token comment">// [revert_offset, revert_size]</span>
    <span class="token keyword">revert</span>        <span class="token comment">// []</span>
    is_owner<span class="token punctuation">:</span>     <span class="token comment">// []</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The exception to this would be the function selector switch in the contract’s entry point, given its common usage.</p> <p>The contract entry point should contain the function selector switch first, with each jump destination having one additional line of whitespace between one another.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// Entry point.</span>
#define <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>
#define <span class="token keyword">function</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>

#define macro <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Grab the function selector from the calldata</span>
    <span class="token number">0x00</span> calldataload <span class="token number">0xE0</span> shr                 <span class="token comment">// [selector]</span>

    dup1 <span class="token function">__FUNC_SIG</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span> eq add_func jumpi     <span class="token comment">// [selector]</span>
    dup1 <span class="token function">__FUNC_SIG</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span> eq sub_func jumpi     <span class="token comment">// [selector]</span>

    <span class="token comment">// Revert if no functions match</span>
    <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token keyword">revert</span>

    add_func<span class="token punctuation">:</span>
        <span class="token function">ADD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sub_func<span class="token punctuation">:</span>
        <span class="token function">SUB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="function-abi-definition"><a href="#function-abi-definition" class="header-anchor">#</a> Function ABI Definition</h2> <p><strong>This is entirely optional, feedback is appreciated here.</strong></p> <p>Defining an external function ABI should consist of two components, the function definition and the 4 byte function selector defined as a constant. Defining a constant representing the function selector directly following a function definition makes for clear usage in the contract’s entry point.</p> <p>The function selector definition should be screaming snake case suffixed with <code>_SEL</code>. This also makes clear the function selector switch’s behavior.</p> <p>Omitting whitespace between the function definition and selector would also make the relationship between the two more clear.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>#define <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>

#define macro <span class="token function">ADD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

#define macro <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Grab the function selector from the calldata</span>
    <span class="token number">0x00</span> calldataload <span class="token number">0xE0</span> shr                 <span class="token comment">// [selector]</span>
    dup1 <span class="token function">__FUNC_SIG</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span> eq add_func jumpi     <span class="token comment">// [selector]</span>

    <span class="token comment">// Revert if no functions match</span>
    <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token keyword">revert</span>

    add_func<span class="token punctuation">:</span>
        <span class="token function">ADD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="event-abi-definition"><a href="#event-abi-definition" class="header-anchor">#</a> Event ABI Definition</h2> <p><strong>This is entirely optional, feedback is appreciated here.</strong></p> <p>Defining an event ABI should consist of two components, the event definition and the 32 byte event signature defined as a constant.</p> <p>The event signature should be screaming snake case suffixed with <code>_SIG</code>.</p> <p>Omitting whitespace between the event definition and signature would also make the relationship between the two more clear.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>#define <span class="token keyword">event</span> <span class="token function">NewOwner</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span>
#define <span class="token keyword">constant</span> NEW_OWNER_SIG <span class="token operator">=</span> <span class="token number">0x3edd90e7770f06fafde38004653b33870066c33bfc923ff6102acd601f85dfbc</span>
</code></pre></div><h2 id="jump-labels"><a href="#jump-labels" class="header-anchor">#</a> Jump Labels</h2> <p><strong>Open to suggestions here.</strong></p> <p>Should instructions following jump labels be indented? Doing so may make execution unclear, as the indention is not taken into consideration at compile time. In the following example, the <code>operation0</code> jump label’s subsequent code is executed, but execution continues at the <code>operation1</code> label, despite it not being clear this is the case.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>operation0
jump

<span class="token comment">// ....</span>

operation0<span class="token punctuation">:</span>
    <span class="token number">0x01</span>     <span class="token comment">// [b]</span>
    <span class="token number">0x02</span>     <span class="token comment">// [a, b]</span>
    add      <span class="token comment">// [sum]</span>
operation1<span class="token punctuation">:</span>
    <span class="token number">0x02</span>     <span class="token comment">// [b, sum]</span>
    <span class="token number">0x01</span>     <span class="token comment">// [a, b, sum]</span>
    sub      <span class="token comment">// [diff, sum]</span>
</code></pre></div><p>It may be best to omit indentation, at least in the standard library.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>operation0
jump

<span class="token comment">// ....</span>

operation0<span class="token punctuation">:</span>
<span class="token number">0x01</span>         <span class="token comment">// [b]</span>
<span class="token number">0x02</span>         <span class="token comment">// [a, b]</span>
add          <span class="token comment">// [sum]</span>
operation1<span class="token punctuation">:</span>
<span class="token number">0x02</span>         <span class="token comment">// [b, sum]</span>
<span class="token number">0x01</span>         <span class="token comment">// [a, b, sum]</span>
sub          <span class="token comment">// [diff, sum]</span>
</code></pre></div><h2 id="contract-call-return"><a href="#contract-call-return" class="header-anchor">#</a> Contract Call Return</h2> <p><strong>Open to suggestions here.</strong></p> <p>There is an issue with using something such as a reentrancy guard, which is a potential <code>return</code> instruction before the lock is restored to the unlocked state. Take the following example.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>#define <span class="token keyword">function</span> <span class="token function">doAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>

#define <span class="token keyword">constant</span> LOCK_SLOT <span class="token operator">=</span> <span class="token function">FREE_STORAGE_POINTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

#define macro <span class="token function">NON_REENTRANT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>LOCK_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [lock_slot]</span>
    sload        <span class="token comment">// [lock]</span>
    iszero       <span class="token comment">// [is_unlocked]</span>
    unlocked     <span class="token comment">// [unlocked_jumpdest]</span>
    jumpi        <span class="token comment">// []</span>
    <span class="token number">0x00</span>         <span class="token comment">// [size]</span>
    <span class="token number">0x00</span>         <span class="token comment">// [offset, size]</span>
    <span class="token keyword">revert</span>       <span class="token comment">// []</span>
    unlocked<span class="token punctuation">:</span>    <span class="token comment">// []</span>
    <span class="token number">0x01</span>         <span class="token comment">// [lock_value]</span>
    <span class="token punctuation">[</span>LOCK_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [lock_slot, lock_value]</span>
    sstore       <span class="token comment">// []</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">UNLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token number">0x01</span>         <span class="token comment">// [lock_value]</span>
    <span class="token punctuation">[</span>LOCK_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [lock_slot, lock_value]</span>
    sstore       <span class="token comment">// []</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">DO_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token number">0x45</span>    <span class="token comment">// [value]</span>
    <span class="token number">0x00</span>    <span class="token comment">// [offset, value]</span>
    mstore  <span class="token comment">// []</span>
    <span class="token number">0x20</span>    <span class="token comment">// [size]</span>
    <span class="token number">0x00</span>    <span class="token comment">// [offset, size]</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Grab the function selector from the calldata</span>
    <span class="token number">0x00</span> calldataload <span class="token number">0xE0</span> shr                       <span class="token comment">// [selector]</span>
    dup1 <span class="token function">__FUNC_SIG</span><span class="token punctuation">(</span>doAction<span class="token punctuation">)</span> eq do_action jumpi     <span class="token comment">// [selector]</span>

    <span class="token comment">// Revert if no functions match</span>
    <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token keyword">revert</span>

    do_action<span class="token punctuation">:</span>
        <span class="token function">NON_REENTRANT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">DO_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">UNLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In this example, <code>DO_ACTION</code> is non-reentrant, so it first uses <code>NON_REENTRANT</code>, but it uses the <code>return</code> instruction internally, which means the <code>UNLOCK</code> macro will never be executed, resulting in a permanently locked function.</p> <p>I’m not sure the best way to handle this until a transient-storage opcode is implemented. Maybe a Huff convention could be established to have these external-function macros like <code>DO_ACTION</code> return a <code>size</code> and <code>offset</code> on the stack, then have the <code>return</code> instruction at the end.</p> <p>The following would be an example of external-function macros returning the stack values instead of using the <code>return</code> instruction, allowing for more safe use of modifiers.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>#define <span class="token keyword">function</span> <span class="token function">doAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>
#define <span class="token keyword">function</span> <span class="token function">otherAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>

#define <span class="token keyword">constant</span> LOCK_SLOT <span class="token operator">=</span> <span class="token function">FREE_STORAGE_POINTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

#define macro <span class="token function">NON_REENTRANT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>LOCK_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [lock_slot]</span>
    sload        <span class="token comment">// [lock]</span>
    iszero       <span class="token comment">// [is_unlocked]</span>
    unlocked     <span class="token comment">// [unlocked_jumpdest]</span>
    jumpi        <span class="token comment">// []</span>
    <span class="token number">0x00</span>         <span class="token comment">// [size]</span>
    <span class="token number">0x00</span>         <span class="token comment">// [offset, size]</span>
    <span class="token keyword">revert</span>       <span class="token comment">// []</span>
    unlocked<span class="token punctuation">:</span>    <span class="token comment">// []</span>
    <span class="token number">0x01</span>         <span class="token comment">// [lock_value]</span>
    <span class="token punctuation">[</span>LOCK_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [lock_slot, lock_value]</span>
    sstore       <span class="token comment">// []</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">UNLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token number">0x00</span>         <span class="token comment">// [lock_value]</span>
    <span class="token punctuation">[</span>LOCK_SLOT<span class="token punctuation">]</span>  <span class="token comment">// [lock_slot, lock_value]</span>
    sstore       <span class="token comment">// []</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">DO_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token number">0x45</span>    <span class="token comment">// [value]</span>
    <span class="token number">0x00</span>    <span class="token comment">// [offset, value]</span>
    mstore  <span class="token comment">// []</span>
    <span class="token number">0x20</span>    <span class="token comment">// [size]</span>
    <span class="token number">0x00</span>    <span class="token comment">// [offset, size]</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">OTHER_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token number">0x00</span>    <span class="token comment">// [size]</span>
    <span class="token number">0x00</span>    <span class="token comment">// [offset, size]</span>
<span class="token punctuation">}</span>

#define macro <span class="token function">MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> takes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Grab the function selector from the calldata</span>
    <span class="token number">0x00</span> calldataload <span class="token number">0xE0</span> shr                          <span class="token comment">// [selector]</span>
    dup1 <span class="token function">__FUNC_SIG</span><span class="token punctuation">(</span>doAction<span class="token punctuation">)</span> eq do_action jumpi        <span class="token comment">// [selector]</span>
    dup1 <span class="token function">__FUNC_SIG</span><span class="token punctuation">(</span>otherAction<span class="token punctuation">)</span> eq other_action jumpi  <span class="token comment">// [selector]</span>

    <span class="token comment">// Revert if no functions match</span>
    <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token keyword">revert</span>


    do_action<span class="token punctuation">:</span>
        <span class="token function">NON_REENTRANT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">DO_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        finish jump

    other_action<span class="token punctuation">:</span>
        <span class="token function">OTHER_ACTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        finish jump

    finish<span class="token punctuation">:</span>
        <span class="token comment">// stack: [offset, size]</span>
        <span class="token function">UNLOCK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f80e70d4.js" defer></script><script src="/assets/js/2.fbc25f86.js" defer></script><script src="/assets/js/19.1dae433e.js" defer></script>
  </body>
</html>
